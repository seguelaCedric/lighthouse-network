# CV Embedding Stale Data Fix

## Problem: Race Condition with CV Uploads

You identified a critical issue: **old embeddings could return stale data** during CV uploads.

### The Race Condition Flow

When a candidate uploads a new CV version:

```
t=0ms     â†’ User uploads CV v2
t=1ms     â†’ Old CV v1 marked as is_latest_version=false
t=100ms   â†’ New CV v2 text extracted
t=101ms   â†’ Candidate queued for embedding regeneration
â”â”â”â”â”â”â”â”â”â”â” [RACE WINDOW - 5-10 SECONDS] â”â”â”â”â”â”â”â”â”â”â”
t=150ms   â†’ ðŸš¨ Vector search happens
            â†’ Returns candidate with OLD embedding from CV v1
            â†’ Search results based on STALE data! âŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
t=5000ms  â†’ Embedding worker processes queue
t=6000ms  â†’ NEW embedding saved to candidates.embedding
t=6001ms+ â†’ âœ… Future searches use correct data
```

### Why This Is Critical

1. **Incorrect Match Results** - Candidates could match jobs based on outdated skills/experience
2. **Missing Candidates** - Candidates with updated qualifications might not appear in searches
3. **Poor UX** - Recruiters see mismatched candidates, losing trust in the system
4. **Extended Window** - If embedding queue is backed up, stale data could persist for minutes

## Solution: Immediate Embedding Invalidation

### Database Change

Updated `create_document_version()` function to **immediately invalidate** the candidate's embedding:

```sql
-- IMPORTANT: Invalidate the candidate's embedding to prevent stale search results
-- The embedding will be regenerated by the embedding worker when the new CV text is extracted
IF v_parent.entity_type = 'candidate' AND v_parent.type = 'cv' THEN
  UPDATE candidates
  SET
    embedding = NULL,
    embedding_text = NULL,
    embedding_updated_at = NOW()
  WHERE id = v_parent.entity_id;
END IF;
```

### New Flow (After Fix)

```
t=0ms     â†’ User uploads CV v2
t=1ms     â†’ Old CV v1 marked as is_latest_version=false
t=1ms     â†’ candidates.embedding = NULL âœ… (invalidated immediately)
t=100ms   â†’ New CV v2 text extracted
t=101ms   â†’ Candidate queued for embedding regeneration
â”â”â”â”â”â”â”â”â”â”â” [SAFE WINDOW] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
t=150ms   â†’ Vector search happens
            â†’ Candidate has embedding=NULL
            â†’ NOT included in semantic search results âœ…
            â†’ Still appears in filter/text searches âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
t=5000ms  â†’ Embedding worker processes queue
t=6000ms  â†’ NEW embedding saved to candidates.embedding
t=6001ms+ â†’ Candidate returns to semantic search with fresh data âœ…
```

## Impact Analysis

### Benefits âœ…

1. **No Stale Results** - Impossible to match candidates on outdated CV data
2. **Data Integrity** - Search results always reflect current state or pending state
3. **Clear Status** - `embedding=NULL` explicitly signals "processing in progress"
4. **Non-Blocking** - Filter-based searches still work during embedding regeneration
5. **Fast Resolution** - Typically 5-10 seconds until candidate returns to semantic search

### Trade-offs âš–ï¸

1. **Temporary Invisibility** - Candidates disappear from semantic search for 5-10 seconds during CV processing
   - **Mitigation**: They still appear in filter searches and text searches
   - **Acceptable**: Better than showing stale data

2. **Queue Dependency** - If embedding queue is backed up, candidates stay hidden longer
   - **Mitigation**: Monitor embedding queue health (existing monitoring in place)
   - **Fallback**: Non-semantic search still works

## Implementation Files

### Migration
- **File**: `supabase/migrations/068_cleanup_old_document_embeddings.sql`
- **Changes**:
  - Clear `extracted_text` and `embedding` from old document versions
  - Invalidate `candidates.embedding` when CV version created
  - Update trigger to only fire for `is_latest_version=true` documents

### Test Script
- **File**: `apps/web/scripts/test-document-version-cleanup.ts`
- **Tests**:
  - Old document data cleared âœ…
  - Candidate embedding invalidated âœ…
  - Metadata preserved for audit trail âœ…
  - New version marked as latest âœ…

### Documentation
- **File**: `apps/web/docs/cv-versioning-cleanup.md`
- **Content**: Full architecture, storage savings, benefits

## Verification Steps

### 1. Run Test Script

```bash
npx tsx apps/web/scripts/test-document-version-cleanup.ts
```

Expected output:
```
âœ… oldVersionFlagCleared
âœ… oldExtractedTextCleared
âœ… oldEmbeddingCleared
âœ… oldMetadataPreserved
âœ… candidateEmbeddingInvalidated      â† Critical test
âœ… candidateEmbeddingTextInvalidated  â† Critical test
âœ… newVersionFlagSet
âœ… newVersionNumber
```

### 2. Manual Testing

1. Upload a CV for a candidate
2. Immediately check `candidates.embedding` â†’ should be NULL
3. Wait 10 seconds
4. Check again â†’ should be populated with new embedding
5. Verify search results reflect new CV content

### 3. Monitor Production

After deployment, monitor:
- `embedding_queue` processing time
- Candidates with `embedding=NULL` count (should be low, transient)
- Search performance (should be unchanged or better)

## Related Systems

### Embedding Worker
- **File**: `apps/web/lib/services/embedding-worker.ts:309`
- **Behavior**: Already filters by `is_latest_version=true`
- **Integration**: No changes needed, will automatically process invalidated candidates

### Document Upload API
- **File**: `apps/web/app/api/documents/upload/route.ts:338-344`
- **Behavior**: Updates `extracted_text` which triggers embedding queue
- **Integration**: No changes needed, existing flow works correctly

### Vector Search Functions
- **Files**: Multiple SQL functions (`match_candidates_by_embedding`, etc.)
- **Behavior**: Automatically exclude candidates with `embedding=NULL`
- **Integration**: No changes needed, NULL embeddings naturally filtered out

## Rollout Plan

### Phase 1: Development Testing
- [x] Create migration with embedding invalidation
- [x] Update test script to verify invalidation
- [x] Run tests locally
- [x] Document behavior and trade-offs

### Phase 2: Staging Validation
- [ ] Apply migration to staging
- [ ] Upload test CV and verify embedding invalidation
- [ ] Run vector searches during processing window
- [ ] Confirm candidate disappears then reappears

### Phase 3: Production Deployment
- [ ] Apply migration during low-traffic period
- [ ] Monitor embedding queue processing
- [ ] Monitor search query performance
- [ ] Verify no candidates stuck with NULL embeddings > 1 hour

### Phase 4: Ongoing Monitoring
- [ ] Add alert for candidates with NULL embedding > 1 hour
- [ ] Track embedding queue backlog
- [ ] Monitor search result quality

## Conclusion

This fix ensures **data integrity** over **temporary availability**. It's better for a candidate to be temporarily absent from semantic search (while still searchable by filters) than to be matched incorrectly based on stale CV data.

The trade-off is minimal (5-10 second processing window) and the benefit is significant (guaranteed fresh results).
